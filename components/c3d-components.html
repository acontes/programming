<html>
<head>
<title>Component programming with ProActive</title>
<link rel="stylesheet" href="../ProActive.css">
</head>
<body bgcolor="white">

<!--
 Header : start
~~~ -->
<table width="100%">
	<tr>
		<td align="left" valign="middle">
		<table cellpadding="2" cellspacing="0" border="1">
			<tr>
				<td class="smallLink1">&nbsp;&nbsp;<a class="smallLink1"
					href="../../../../overview-summary.html">back to API</a>&nbsp;&nbsp;</td>
				<td class="smallLink1">&nbsp;&nbsp;<a class="smallLink1"
					href="../index.html">back to index</a>&nbsp;&nbsp;</td>
				<td class="smallLink2">&nbsp;&nbsp;<a class="smallLink2"
					href="../exceptions.html">prev</a>&nbsp;&nbsp;</td>
				<td class="smallLink2">&nbsp;&nbsp;<a class="smallLink2"
					href="../Security.html">next</a>&nbsp;&nbsp;</td>
			</tr>
		</table>
		</td>
		<td align="right" valign="top"><img src="../ProActiveLogo200x34.gif"
			alt=""></td>
	</tr>

</table>
<hr>
<!-- Link to index : end -->


<h1>C3D - from Active Objects to Components</h1>

<h2>Reason for this example</h2>

<p class="textNormal">This is an example of an application that is
refactored to fit the components dogma. The standard C3D example has
been taken as a basis, and component wrappers have been created. This
way, one can see what is needed to transform an application into
component-oriented code.</p>

<p>You may find the code in the <a
	href="../doc/ProActive_src_html/org.objectweb.proactive.examples.components.c3d.index.html">
examples/components/c3d</a> directory of the proactive source.</p>

<h2>Using working C3D code with components</h2>

<img src="pics/C3D-Components-UML.png"
	alt="C3D Components simplified UML" align=right>

<p>We consider the working C3D application. It's nice, and has a sleak
GUI, but we now want to add component power to it! What we do is shown
on the image to the right: add wrappers around the original object
classes (C3D*) and instead of linking the classes together by setting
fields through the initial methods, do that in the binding methods. In
other words, we have to spot exactly where C3DRenderingEngine, C3DUser
and C3DDispatcher are used by a class other than itself, and make theses
references component bindings. Of course, we also have to expose the
interfaces that we are goining to use, hence the Dispatcher, Engine and
User interface that have to be implemented.</p>

<br clear> <!-- Means stop indenting while including the image on the right...  -->

<h2>How the application is written</h2>

<p>First of all, have a look at the doc on <a href="c3d.html">C3D</a> to
remember how this application is written. Most important is
the class diagram, showing C3DUser, C3DDispatcher and C3DRederingEngine.
We decided that the only objects worth wrapping in components were those
three. The rest is too small to be worth the hassle.</p>

<h3>Creating the interfaces</h3>

<p>What we need to do is to extract the interfaces of the Objects, ie
the which methods are going to be called on the components. This means
find out what methods are called from outside the Active Object. You can
do that by searching in the classes where the calls are made on active
objects. For this, <b>you have to know in detail which classes are going
to be turned into component</b>. We have done that, and those exposed
methods are put in the interfaces User, Engine and Dispatcher.</p>

<p><b>Tricky part:</b> whatever way you look at components, you'll have
to modify the initial code if these interfaces were not created at
first go. You have to replace all the classes
by their interface, when you use them in other files. If we had not already
used interfaces in the C3D Objecct code, we would have had to replace all 
occurrences of C3DDispatcher by occurrences of Dispatcher. </p>

<p>Why do we have to do that, replacing classes by interfaces? That's
due to the way components work. When the components are going to be
bound, you're not binding the class themselves, but proxies to these
classes. And these proxies implement the interfaces, and do not extend
the classes.</p>

<h3>Creating the Component Wrappers</h3>

<p>You now have to create a class that englobes the previous Active
Objects, and which is a composent representing the same functionality.
How do you do that? Pretty simple. All you need to do is extend the
Active Object class, and add to it the non-functional interfaces which
go with the component. You have the binding interfaces to create, which
basically say how to put together two Components, tell who is already
attached, and how to separate them. These are the <code>lookupFc</code>,
<code>bindFc</code>, <code>unbindFc</code>, and <code>listFc</code>
methods.</p>

<p>This has been done in the *Impl files. Have a peek, for example, at <a
	href="../doc/ProActive_src_html/org.objectweb.proactive.examples.c3d.UserImpl.html">
UserImpl.java</a>. What you have here are those component methods. Be
even more careful with this <code>bindFc</code> method. In fact, it
really binds the protected Dispatcher variable <code>c3ddispatcher</code>.
This way, the C3DUser code can now use this varaible as if it was
addressing the real Active Object. Just to be precise, we have to point
out that you're going through proxies before reaching the Component,
then the Active Object. But this is hidden by the ProActive layer, all
you should know is you're addressing a Dispatcher, and you're fine!</p>

<h3>Discarding direct reference acknowledgment</h3>

<p>If you're out of luck, the code contains instructions to retain
references to objects that call methods on the current Object. These
methods have a signature ressembling <code>method(..., ActiveObject ao,
...)</code>. This is called, in ProActive, with a <code>ProActive.getStubOnThis()</code>
(if you don't, and instead use 'this', the code won't work correctly on remote hosts!). If the
local object uses this <code>ProActive.getStubOnThis()</code>, you're going to have trouble with
components. The problem is that this design does not fit the component paradigm : you should be 
using declared interfaces bound with the bind methods, not be passing along references to self.
So you have to remove these from the code, and make it component-oriented. But remember, 
<b>you should be using bind methods to attach other components</b>.</p>

<p>OK, we have left a <code>Fractive.getComponentRepresentativeOnThis()</code>
in the user code. Can you guess why? Because we have a very special
relationship between users and dispatchers. This link is two-way, ie
users call methods on their dispatcher, and the dispatcher calls methods
on its users. But even worse, the dispatcher points its users by id.
This id is generated on the fly, when a user registers. Now, how is this
compatible with external binding and unbinding of components? Well,
that's tough. In fact the way we devised was to do it at binding-time :
inside the <code>bindFc</code> and <code>unbindFc</code> methods, the
components engage a conversation in which they share their references
and set the correct id.</p>

<h2>ADL</h2>

<p>You may be wanting to see how we have bound the components together, now. Since the design is
pretty simple, there is not much to it. We have used the fractal ADL, to avoid hard-coding bindings.
So all of the information here is in the <code>components/c3d/fractal/</code> directory. There are
the components (which interfaces they propose), and a "distributed.fractal" file, which is where the
bindings are made. It includes the creation of a Composite component, just for the fun. You may want
to explore it with the Fractal GUI provided with IC2D, it's easier to understand graphically. Here's
the code, nevertheless, for you curiosity :</p>

<pre>
&lt;?xml version="1.0" encoding="ISO-8859-1" ?&gt;
&lt;!DOCTYPE definition PUBLIC "-//objectweb.org//DTD Fractal ADL 2.0//EN" 
     "classpath://org/objectweb/proactive/core/component/adl/xml/proactive.dtd"&gt;

&lt;definition name="org.objectweb.proactive.examples.components.c3d.fractal.distributed"&gt;
  &lt;interface signature="java.lang.Runnable" role="server" name="r"/&gt;
  &lt;component definition="org.objectweb.proactive.examples.components.c3d.fractal.UserImpl" name="user" /&gt;
  &lt;component name="Composite"&gt;
    &lt;interface signature="org.objectweb.proactive.examples.c3d.Dispatcher" role="server" name="dispatch"/&gt;
    &lt;component definition="org.objectweb.proactive.examples.components.c3d.fractal.EngineImpl" name="engine2"/&gt;
    &lt;component definition="org.objectweb.proactive.examples.components.c3d.fractal.EngineImpl" name="engine1"/&gt;
    &lt;component definition="org.objectweb.proactive.examples.components.c3d.fractal.DispatcherImpl" name="disp"/&gt;
    &lt;binding client="this.dispatch" server="disp.user2dispatcher"/&gt;
    &lt;binding client="disp.dispatcher2engine00" server="engine1.dispatcher2engine"/&gt;
    &lt;binding client="disp.dispatcher2engine01" server="engine2.dispatcher2engine"/&gt;
  &lt;/component&gt;
  &lt;binding client="this.r" server="user.r"/&gt;
  &lt;binding client="user.user2dispatcher" server="Composite.dispatch"/&gt;
  &lt;controller desc="composite"/&gt;
  &lt;coordinates color="-73" y0="0.11" x1="0.30" y1="0.33" name="user" x0="0.03"/&gt;
  &lt;coordinates color="-73" y0="0.18" x1="0.99" y1="0.98" name="Composite" x0="0.32"&gt;
    &lt;coordinates color="-73" y0="0.60" x1="0.84" y1="0.89" name="engine2" x0="0.23"/&gt;
    &lt;coordinates color="-73" y0="0.15" x1="0.99" y1="0.53" name="engine1" x0="0.72"/&gt;
    &lt;coordinates color="-73" y0="0.12" x1="0.67" y1="0.42" name="disp" x0="0.09"/&gt;
  &lt;/coordinates&gt;
&lt;/definition&gt;
</pre>




<h2>Source Code</h2>

<p class="textNormal">You may find the source code of this application
at the following locations : </p>
<ul>
	<li><a
		href="../doc/ProActive_src_html/org.objectweb.proactive.examples.c3d.index.html">Active
	Object version</a> ( examples/c3d )</li>
	<li><a
		href="../doc/ProActive_src_html/org.objectweb.proactive.examples.components.c3d.index.html">Component
	version</a>  ( examples/components/c3d )</li>
</ul>

<hr>
<p class="textSmall"><i> History :<br>
 November 2005: first version </i></p>

<!--
 Footer : start
~~~ -->
<br>
<hr>
<div align="right" class="textSmall">Copyright &#169;  2001-2005 INRIA
All Rights Reserved.
<p class="textNormal"></p>
<!-- Footer : end --></div>
</body>
</html>
